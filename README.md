# spring-security-practice

## ìŠ¤í”„ë§ ì‹œíë¦¬í‹°

[ìŠ¤í”„ë§ ì‹œíë¦¬í‹° 1 : ì‹¤ìŠµ ëª©í‘œ ë° ê°„ë‹¨í•œ ë™ì‘ ì›ë¦¬](https://www.youtube.com/watch?v=y0PXQgrkb90&list=PLJkjrxxiBSFCKD9TRKDYn7IE96K2u3C3U)

> ì‹œíë¦¬í‹° ë™ì‘ ì›ë¦¬
> 

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a0ff2a03-773c-4953-af24-b9d7906c8e17/9a888c3d-f151-4aa8-af74-ae9459a911af/image.png)

ìŠ¤í”„ë§ì€ ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆ ìœ„ì— ì¡´ì¬í•˜ê³  ìˆìŒ â†’ í´ë¼ì´ì–¸íŠ¸ ìš”ì²­í•˜ë©´ ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆê°€ ìš”ì²­ ë°›ì•„ì„œ ì—¬ê¸° ì•ˆì— ì¡´ì¬í•˜ëŠ” í•„í„°ë“¤ ê±°ì¹œ í›„ì—, ìŠ¤í”„ë§ ë¶€íŠ¸ì— ìš”ì²­ì´ ë„ë‹¬í•˜ê²Œ ë˜ëŠ”ë° â†’ ìŠ¤í”„ë§ ì‹œíë¦¬í‹° config íŒŒì¼ì„ ë“±ë¡í•´ë‘ë©´, config íŒŒì¼ì´ í•„í„°ì— íŠ¹ì •í•œ í•„í„°ë¥¼ ë§Œë“¤ì–´ì„œ í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì„ ê°€ë¡œì±” â†’ í´ë¼ì´ì–¸íŠ¸ê°€ ê°€ê³ ì‹¶ì€ ëª©ì ì§€ ì´ì „ì— í•´ë‹¹ í´ë¼ì´ì–¸íŠ¸ê°€ ê¶Œí•œì´ ìˆëŠ”ì§€ ë¶„ì„í•¨ â†’ ë§Œì•½ì— admin controller ê°€ê³ ì‹¶ì€ë°, admin ê¶Œí•œì´ì—†ìœ¼ë©´ í•„í„°ì—ì„œ ê¶Œí•œì„ ë§‰ê²Œ ë¨ â†’ ë¡œê·¸ì¸ ì§„í–‰í•´ì•¼ í•  ê²½ìš° í•„í„°ì—ì„œ ëª¨ë“  ìœ ì €ì— ëŒ€í•œ ì ‘ê·¼ í—ˆìš©í•´ì„œ ë¡œê·¸ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ì„œ ë¡œê·¸ì¸ ì§„í–‰í•˜ê³  â†’ ì„¸ì…˜ì— ë¡œê·¸ì¸ ì •ë³´ê°€ ë“±ë¡ë¨. â†’ ì´í›„ ë‹¤ë¥¸ í˜ì´ì§€ ê°ˆë•ŒëŠ” ì„¸ì…˜ì— ìœ ì €ê°€ ë“±ë¡ë˜ì–´ìˆì–´ì„œ í•„í„°ì—ì„œ í†µê³¼ë¥¼ í—ˆìš©ì‹œì¼œì„œ ë§ˆì´í˜ì´ì§€ ì»¨íŠ¸ë¡¤ëŸ¬ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŒ

[Spring Securityë€? ì‚¬ìš©í•˜ëŠ” ì´ìœ ë¶€í„° ì„¤ì • ë°©ë²•ê¹Œì§€ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤! I ì´ëœì„œ ë¸”ë¡œê·¸](https://www.elancer.co.kr/blog/view?seq=235)

> í”„ë¡œì íŠ¸ ìƒì„±
> 

[ê°œë°œì ìœ ë¯¸ | ì»¤ë®¤ë‹ˆí‹°](https://www.devyummi.com/page?id=668bd5de16014d6810ed85f3)

cf. **ë¨¸ìŠ¤í…Œì¹˜(Mustache)**Â ëŠ” JSPì™€ ê°™ì´ HTMLì„ ë§Œë“¤ì–´ ì£¼ëŠ” í…œí”Œë¦¿ ì—”ì§„

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a0ff2a03-773c-4953-af24-b9d7906c8e17/e707e2e4-6eb7-48c4-b424-e025bbe54a3d/image.png)

[[Spring Boot] Chap 4.Mustacheë¡œ í™”ë©´ êµ¬ì„±í•˜ê¸°](https://doorisopen.github.io/spring/2020/03/03/spring-freelec-springboot-chap4.html)

> ì¸ê°€
> 

[ê°œë°œì ìœ ë¯¸ | ì»¤ë®¤ë‹ˆí‹°](https://www.devyummi.com/page?id=668bd6bf16014d6810ed85f5)

<aside>
ğŸ’¡ íŠ¹ì •í•œ ê²½ë¡œì— ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ Controller í´ë˜ìŠ¤ì— ë„ë‹¬í•˜ê¸° ì „ í•„í„°ì—ì„œ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ë¯¸ë¦¬ ê²€ì¦ì„ í•˜ëŠ” ì‘ì—…

</aside>

: íŠ¹ì •í•œ ê²½ë¡œëŠ” ëª¨ë‘ì—ê²Œ ì˜¤í”ˆ ì‹œí‚¤ê³ , ë‹¤ë¥¸ íŠ¹ì •í•œ ê²½ë¡œëŠ” ì¸ê°€ëœ ì‚¬ìš©ìì—ê²Œë§Œ ì˜¤í”ˆ ì‹œí‚¤ë„ë¡ ì‹¤ìŠµ

â‡’ ì´ëŸ° ì‘ì—…ì„ í•˜ë ¤ë©´ Security Configuration (ì¸ê°€ ì„¤ì •ì„ ì§„í–‰í•˜ëŠ” í´ë˜ìŠ¤) 

cf. ê¸°ë³¸ì ì¸ ì¸ê°€ ì‘ì—…ì€ ëª¨ë“  ê²½ë¡œì— ëŒ€í•´ì„œ ë¡œê·¸ì¸í•˜ë„ë¡ ì§€ì •ë˜ì–´ ìˆìŒ 

- ë”°ë¡œ ì»¤ìŠ¤í…€ í•˜ë ¤ë©´ config í´ë˜ìŠ¤ë¥¼ ë“±ë¡í•´ë‘¬ì•¼ í•¨

[ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œ @EnableWebSecurity ì–´ë…¸í…Œì´ì…˜ì˜ í™œìš© ë°©ë²•ê³¼ ê¸°ëŠ¥](https://jjangadadcodingdiary.tistory.com/entry/ìŠ¤í”„ë§-ì‹œíë¦¬í‹°ì—ì„œ-EnableWebSecurity-ì–´ë…¸í…Œì´ì…˜ì˜-í™œìš©-ë°©ë²•ê³¼-ê¸°ëŠ¥)

[SpringSecurity - antMatchers()ì™€ requestMatchers() ì°¨ì´](https://velog.io/@jeongm/SpringSecurity-antMatchersì™€-requestMatchers-ì°¨ì´)

- **`permitAll`** : ë¡œê·¸ì¸ í•˜ì§€ ì•Šì•„ë„ ëª¨ë“  ì‚¬ìš©ìê°€ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
- **`hasRole`** : íŠ¹ì •í•œ ë¡œê·¸ì¸ ê°™ì€ ê·œì¹™ì´ ìˆì–´ì•¼ ì´ ê²½ë¡œì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
- **`authenticated`** : ë¡œê·¸ì¸ë§Œ ì§„í–‰í•˜ë©´ ëª¨ë‘ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
- **`denyAll`** : ë¡œê·¸ì¸í•´ë„ ëª¨ë“  ì‚¬ìš©ì ì ‘ê·¼í•˜ì§€ ëª»í•˜ë„ë¡ ì„¤ì •

â‡’ ë™ì‘ë˜ëŠ” ìˆœì„œê°€ ìƒë‹¨ë¶€í„° ì§„í–‰ë˜ì„œ ìˆœì„œ ì¤‘ìš”í•¨ 

: ì²˜ìŒì— anyRequest í•˜ë©´ ì•ˆë¨. 

ê°€ì¥ ì•„ë˜ì—ì„œ ëª¨ë“  ê²½ë¡œì— ëŒ€í•œ ì„¸íŒ…ì„ ì§„í–‰í•´ì¤˜ì•¼ í•¨ 

```java
package com.example.securityprac.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity // spring security í™œì„±í™” (ì›¹ ë³´ì•ˆ í™œì„±í™”)
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {

        http
                .authorizeHttpRequests((auth) -> auth
                        .requestMatchers("/", "/login").permitAll()
                        .requestMatchers("/admin").hasRole("ADMIN")
                        .requestMatchers("/my/**").hasAnyRole("ADMIN", "USER")
                        .anyRequest().authenticated());
                // requestMatchers : íŠ¹ì •í•œ url ì— ëŒ€í•´ ê²½ë¡œ ì„¤ì •
                // + ë³´ì•ˆ ì„¤ì •
                // anyRequest : ìœ„ì—ì„œ ì²˜ë¦¬ í•˜ì§€ ëª»í•œ ë‚˜ë¨¸ì§€ ê²½ë¡œ ì²˜ë¦¬

        return http.build();
    }

}

```

cf. ì‹œíë¦¬í‹° ë²„ì „ë³„ êµ¬í˜„ ë°©ë²•

[ê°œë°œì ìœ ë¯¸ | ì»¤ë®¤ë‹ˆí‹°](https://www.devyummi.com/page?id=668bd7fe16014d6810ed85f7)

â‡’ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ í™•ì¸í•˜ê¸°

https://github.com/spring-projects/spring-security/releases

: ìŠ¤í”„ë§ ë¶€íŠ¸ 3 ë²„ì „ìœ¼ë¡œ 

> ì»¤ìŠ¤í…€ ë¡œê·¸ì¸
> 

[ê°œë°œì ìœ ë¯¸ | ì»¤ë®¤ë‹ˆí‹°](https://www.devyummi.com/page?id=668bd94716014d6810ed85f9)

â†’ ë¡œê·¸ì¸ í•˜ì§€ ì•Šì€ ìƒíƒœë¡œ íŠ¹ì •í•œ admin ê²½ë¡œì— ì ‘ê·¼í•˜ê²Œ ë˜ë©´, í˜ì´ì§€ ì—‘ì„¸ìŠ¤ ìì²´ê°€ ê±°ë¶€ë¨ (ë¦¬ë‹¤ì´ë ‰íŒ… ì‘ì—…ì´ í•„ìš”) 

: íŠ¹ì • ê²½ë¡œì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ëŠ” ê²½ìš° ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŒ… ë˜ì§€ ì•Šê³  ì˜¤ë¥˜ í˜ì´ì§€ê°€ ë°œìƒ

- csrf : ìŠ¤í”„ë§ ìœ„ë³€ì¡° ë°©ì§€ ì„¤ì •
    
    csrf í† í° - ì„œë²„ì— ë“¤ì–´ì˜¨ ìš”ì²­ì´ ì‹¤ì œ ì„œë²„ì—ì„œ í—ˆìš©í•œ ìš”ì²­ì´ ë§ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•œ í† í° 
    
    [CSRFí† í°ì´ë€?](https://velog.io/@jupiter-j/CSRFí† í°ì´ë€)
    
    â‡’ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ëŠ” csrfê°€ ìë™ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŒ. ê·¼ë°, ì´ ì„¤ì •ì´ ë™ì‘ë˜ë©´ post ìš”ì²­ì„ ë³´ë‚¼ ë•Œ csrf í† í°ë„ ë³´ë‚´ì£¼ì–´ì•¼ ë™ì‘ì´ ë¨. (ê°œë°œ í™˜ê²½ì—ì„œëŠ” êº¼ë‘¬ì•¼ ë¡œê·¸ì¸ ì§„í–‰ë¨) 
    

```java
package com.example.securityprac.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity // spring security í™œì„±í™” (ì›¹ ë³´ì•ˆ í™œì„±í™”)
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {

        http
                .authorizeHttpRequests((auth) -> auth
                        .requestMatchers("/", "/login").permitAll()
                        .requestMatchers("/admin").hasRole("ADMIN")
                        .requestMatchers("/my/**").hasAnyRole("ADMIN", "USER")
                        .anyRequest().authenticated());
                // requestMatchers : íŠ¹ì •í•œ url ì— ëŒ€í•´ ê²½ë¡œ ì„¤ì •
                // + ë³´ì•ˆ ì„¤ì •
                // anyRequest : ìœ„ì—ì„œ ì²˜ë¦¬ í•˜ì§€ ëª»í•œ ë‚˜ë¨¸ì§€ ê²½ë¡œ ì²˜ë¦¬

        http
                .formLogin((auth) -> auth.loginPage("/login")
                        .loginProcessingUrl("/LoginProc")
                        .permitAll());

                // loginPage : login page ë¡œ redirect
                // loginProcessingUrl : login í•œ ë°ì´í„°ë¥¼ íŠ¹ì •í•œ ê²½ë¡œë¡œ ë³´ëƒ„

        http
                .csrf((auth)->auth.disable());

        return http.build();
    }

}

```

> BCrypt ì•”í˜¸í™” ë©”ì†Œë“œ
> 

[ê°œë°œì ìœ ë¯¸ | ì»¤ë®¤ë‹ˆí‹°](https://www.devyummi.com/page?id=668bda0b16014d6810ed85fb)

- ì•”í˜¸í™”ë¥¼ ë¬´ì¡°ê±´ ì§„í–‰í•´ì•¼ í•¨.
- ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•  ë•Œ ì•„ì´ë””ë‘ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê²€ì¦í•˜ëŠ”ë°, ë¹„ë°€ë²ˆí˜¸ëŠ” ë‹¨ë°©í–¥ í•´ì‹œ ì•”í˜¸í™”ë¥¼ ì§„í–‰í•´ì„œ ì €ì¥ë˜ì–´ ìˆëŠ” ë¹„ë°€ë²ˆí˜¸ì™€ ëŒ€ì¡°í•¨. (ë¹„ë°€ë²ˆí˜¸ë¥¼ ì €ì¥í•  ë•Œë„ í•´ì‹œ ì•”í˜¸í™” í•´ì„œ ì €ì¥í•´ì•¼ í•¨)
- ì´ëŸ° ì•”í˜¸í™”ë¥¼ ìœ„í•´ BCrypt í´ë˜ìŠ¤ë¥¼ ì œê³µí•˜ê³  ìˆìŒ
- ê·¸ë˜ì„œ ì´ í´ë˜ìŠ¤ë¥¼ return í•˜ëŠ” ë©”ì†Œë“œë¥¼ ë§Œë“¤ì–´ @Beanìœ¼ë¡œ ë“±ë¡í•´ë‘ë©´ íšŒì›ê°€ì…, ê²€ì¦í•  ë•Œ ìë™ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆìŒ

**[ë‹¨ë°©í–¥ í•´ì‹œ ì•”í˜¸í™”]**

: ë°ì´í„°ë¥¼ ê³ ì •ëœ í¬ê¸°ì˜ í•´ì‹œ ê°’ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ê³¼ì • (ì´ í•´ì‹œ ê°’ì—ì„œ ì›ë˜ì˜ ë°ì´í„°ë¥¼ ë³µêµ¬í•˜ëŠ” ê²ƒì´ ë§¤ìš° ì–´ë µê±°ë‚˜ ë¶ˆê°€ëŠ¥í•œ ì•”í˜¸í™” ë°©ì‹)

cf. í•´ì‹œí•¨ìˆ˜ëŠ” ë‹¨ë°©í–¥ (ì›ë³¸ ë°ì´í„°ë¥¼ í•´ì‹œ ê°’ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ê²ƒì€ ì‰½ì§€ë§Œ, í•´ì‹œ ê°’ì—ì„œ ì›ë³¸ ë°ì´í„°ë¥¼ ë³µì›í•˜ëŠ” ê²ƒì€ ì‚¬ì‹¤ìƒ ë¶ˆê°€ëŠ¥)

```java
@Bean
public BCryptPasswordEncoder bCryptPasswordEncoder() {
    return new BCryptPasswordEncoder();
}
```

> DB ì—°ê²°
> 

[ê°œë°œì ìœ ë¯¸ | ì»¤ë®¤ë‹ˆí‹°](https://www.devyummi.com/page?id=668bda7916014d6810ed85fd)

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-09-02 á„‹á…©á„’á…® 11.16.18.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a0ff2a03-773c-4953-af24-b9d7906c8e17/f0aeb53d-9cc2-41c4-a044-cf8bc2f71226/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-09-02_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_11.16.18.png)

> íšŒì›ê°€ì… ë¡œì§
> 

[ê°œë°œì ìœ ë¯¸ | ì»¤ë®¤ë‹ˆí‹°](https://www.devyummi.com/page?id=668bdd44b374ad837c3f9deb)

- íšŒì›ì •ë³´ë¥¼ í†µí•´ ì¸ì¦, ì¸ê°€ë¥¼ ì§„í–‰í•˜ê¸° ë•Œë¬¸ì— ë¡œê·¸ì¸ì´ ì§„í–‰ë˜ì–´ì•¼ í•œë‹¤.
- ê¸°ì¡´ì— ìŠ¤í”„ë§ ì–´í”Œë¦¬ì¼€ì´ì…˜ì— ì €ì¥ëœ íšŒì› ì •ë³´ë¥¼ ê°€ì§€ê³  ì§„í–‰í•˜ê²Œ ë˜ëŠ”ë°, ìŠ¤í”„ë§ ì–´í”Œë¦¬ì¼€ì´ì…˜ì— ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©ìì˜ íšŒì› ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆì–´ì•¼ í•œë‹¤.

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-09-08 á„‹á…©á„’á…® 6.53.47.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a0ff2a03-773c-4953-af24-b9d7906c8e17/56424ac8-b11b-445b-a278-cfbee4f48ed0/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-09-08_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_6.53.47.png)

1. ìš°ì„  í˜ì´ì§€ ë¨¼ì € ìƒì„±

```java
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>

<form action="/joinProc" method="post" name="joinForm">
    <input type="text" name="username" placeholder="Username"/>
    <input type="password" name="password" placeholder="Password"/>
    <input type="submit" value="Join"/>
</form>

</body>
</html>
```

1. dto ê°ì²´ 

```java
package com.example.securityprac.dto;

import lombok.Getter;
import lombok.Setter;

@Setter
@Getter
public class JoinDto {

    private String userName;
    private String password;

}

```

1. Controllerì— ë„˜ì–´ê°€ëŠ” í˜ì´ì§€ ì§€ì •

```java
package com.example.securityprac.controller;

import com.example.securityprac.dto.JoinDto;
import com.example.securityprac.service.JoinService;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;

@Controller
@RequiredArgsConstructor
public class JoinController {

    private final JoinService joinService;

    @GetMapping("/join")
    public String joinP() {
        return "join";
    }

    @PostMapping("/joinProc")
    public String joinProcess(JoinDto joinDto) {

        System.out.println(joinDto.getUserName());

        joinService.joinProcess(joinDto);

        return "redirect:/login";
    }
}

```

1. Entity ìƒì„± (user) 

```java
package com.example.securityprac.entity;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import lombok.Getter;
import lombok.Setter;

@Entity
@Getter
@Setter
public class UserEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    private String username;
    private String password;
    private String role; // ê¶Œí•œì„ ì €ì¥í•  role ê°’ ë„£ì–´ ì£¼ê¸°

}

```

1. DBì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ Repository ìƒì„±

: ë¬´ì¡°ê±´ interface í˜•íƒœë¡œ ìƒì„±

```java
package com.example.securityprac.repository;

import com.example.securityprac.entity.UserEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UserRepository extends JpaRepository<UserEntity, Integer> {

    

}

```

1. Tableì€ **Hibernate ddl**ë¡œ ì„¤ì •

â†’ updateë¡œ í•´ë‘ë©´ entityë¥¼ ê¸°ë°˜ìœ¼ë¡œ í…Œì´ë¸”ì´ ìƒì„±ë¨ 

```java
spring.application.name=SecurityPrac

spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/SecurityPrac?useSSL=false&useUnicode=true&serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true
spring.datasource.username=root
spring.datasource.password=0070

spring.jpa.hibernate.ddl-auto=update
spring.jpa.hibernate.naming.physical-strategy=org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
```

[[JPA] hibernateì˜ ddl-auto ì†ì„±ì˜ ì¢…ë¥˜ì™€ ì£¼ì˜í•´ì•¼í•  ì ](https://colabear754.tistory.com/136)

: ê·¸ëƒ¥ ì‹¤í–‰í• ë•Œë§Œ update 

(í…Œì´ë¸” ë§Œë“¤ì–´ë‘ë©´ ë‹¤ì‹œ noneìœ¼ë¡œ ë°”ê¾¸ê¸°) 

1. Service ë¡œì§ êµ¬í˜„

: ROLE_ADMIN, ROLE_USER â† role ë„£ì–´ì£¼ê¸°

```java
package com.example.securityprac.service;

import com.example.securityprac.dto.JoinDto;
import com.example.securityprac.entity.UserEntity;
import com.example.securityprac.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@RequiredArgsConstructor
@Transactional
public class JoinService {

    private final UserRepository userRepository;
    private final BCryptPasswordEncoder bCryptPasswordEncoder;

    public void joinProcess(JoinDto joinDto) {

        // DBì— ë™ì¼í•œ username ì„ ê°€ì§„ íšŒì›ì´ ì¡´ì¬ í•˜ëŠ”ì§€ ê²€ì¦ í•„ìˆ˜ !!

        UserEntity data = new UserEntity();

        data.setUsername(joinDto.getUserName());
        data.setPassword(bCryptPasswordEncoder.encode(joinDto.getPassword()));
        data.setRole("ROLE_USER");

        userRepository.save(data);
    }

}

```

1. SecurityConfig ì ‘ê·¼ ê¶Œí•œ ì„¤ì •

```java
http
                .authorizeHttpRequests((auth) -> auth
                        .requestMatchers("/", "/login", "/join", "/joinProc").permitAll()
                        .requestMatchers("/admin").hasRole("ADMIN")
                        .requestMatchers("/my/**").hasAnyRole("ADMIN", "USER")
                        .anyRequest().authenticated());
```

: join, joinProcë„ ë„£ì–´ì¤˜ì•¼ ë¡œê·¸ì¸í•˜ì§€ ì•Šì•„ë„ ëª¨ë“  userê°€ ì ‘ê·¼ ê°€ëŠ¥í•´ì§ (ì´ ê²½ë¡œì— ì ‘ê·¼í•´ì„œ íšŒì›ê°€ì…ì„ ì§„í–‰í•´ì•¼ í•˜ë¯€ë¡œ) 

> íšŒì› ì¤‘ë³µ ê²€ì¦ ë°©ë²•
> 

[ê°œë°œì ìœ ë¯¸ | ì»¤ë®¤ë‹ˆí‹°](https://www.devyummi.com/page?id=668be19d654633b8ec42f660)

- ì¤‘ë³µëœ ê°€ì…ì— ëŒ€í•œ ë¡œì§ì„ ì²˜ë¦¬í•´ì¤˜ì•¼ í•¨

â†’ ì´ columnì´ unique í•  ìˆ˜ ìˆë„ë¡

1. Entity ìˆ˜ì •

```java
package com.example.securityprac.entity;

import jakarta.persistence.*;
import lombok.Getter;
import lombok.Setter;

@Entity
@Getter
@Setter
public class UserEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int id;

    @Column(unique = true)
    private String username;
    private String password;
    private String role; // ê¶Œí•œì„ ì €ì¥í•  role ê°’ ë„£ì–´ ì£¼ê¸°

}

```

1. Repository 

```java
package com.example.securityprac.repository;

import com.example.securityprac.entity.UserEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UserRepository extends JpaRepository<UserEntity, Integer> {

    // ì¡´ì¬í•˜ë©´ true, ì•„ë‹ˆë©´ false 
    boolean existsByUsername(String username);
}

```

1. Service

```java
package com.example.securityprac.service;

import com.example.securityprac.dto.JoinDto;
import com.example.securityprac.entity.UserEntity;
import com.example.securityprac.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@RequiredArgsConstructor
@Transactional
public class JoinService {

    private final UserRepository userRepository;
    private final BCryptPasswordEncoder bCryptPasswordEncoder;

    public void joinProcess(JoinDto joinDto) {

        // DBì— ë™ì¼í•œ username ì„ ê°€ì§„ íšŒì›ì´ ì¡´ì¬ í•˜ëŠ”ì§€ ê²€ì¦ í•„ìˆ˜ !!
        boolean isUser = userRepository.existsByUsername(joinDto.getUserName());
        if (isUser) { // ë™ì¼í•œ íšŒì› ì´ë©´ 
            return; // í•¨ìˆ˜ ì¢…ë£Œ 
        }

        UserEntity data = new UserEntity();

        data.setUsername(joinDto.getUserName());
        data.setPassword(bCryptPasswordEncoder.encode(joinDto.getPassword()));
        data.setRole("ROLE_USER");

        userRepository.save(data);
    }

}

```

- ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸ì— ëŒ€í•œ ì •ê·œì‹ ì²˜ë¦¬ë„ í•„ìš”í•¨!
    - ì•„ì´ë””ì˜ ìë¦¬ìˆ˜
    - ì•„ì´ë””ì˜ íŠ¹ìˆ˜ë¬¸ì í¬í•¨ ë¶ˆê°€
    - adminê³¼ ê°™ì€ ì•„ì´ë”” ì‚¬ìš© ë¶ˆê°€
    - ë¹„ë°€ë²ˆí˜¸ ìë¦¬ìˆ˜
    - ë¹„ë°€ë²ˆí˜¸ íŠ¹ìˆ˜ë¬¸ì í¬í•¨ í•„ìˆ˜

> DB ê¸°ë°˜ ë¡œê·¸ì¸ ê²€ì¦ ë¡œì§
> 

[ê°œë°œì ìœ ë¯¸ | ì»¤ë®¤ë‹ˆí‹°](https://www.devyummi.com/page?id=668be4696a08359d16576c45)

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-09-08 á„‹á…©á„’á…® 10.29.46.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/a0ff2a03-773c-4953-af24-b9d7906c8e17/d3780bad-065f-4733-84a7-c912ffb7f1d1/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-09-08_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_10.29.46.png)

â†’ ë°ì´í„°ë² ì´ìŠ¤ë¡œë¶€í„° ì €ì¥ëœ íšŒì›ì •ë³´ë¥¼ ê°€ì§€ê³  ë“¤ì–´ì˜¤ëŠ” ë°ì´í„°ë¡œ ì•„ì´ë”” ê²€ì¦ì„ ì§„í–‰í•˜ë ¤ë©´ UserDetailService, UserDetailsë¥¼ í†µí•´ êµ¬í˜„ í•´ì•¼í•œë‹¤. 

[Spring Security UserDetails, UserDetailsService ë€? - ì‚½ì§ˆì¤‘ì¸ ê°œë°œì](https://programmer93.tistory.com/68#google_vignette)

1. Repository

```java
package com.example.securityprac.repository;

import com.example.securityprac.entity.UserEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UserRepository extends JpaRepository<UserEntity, Integer> {

    // ì¡´ì¬í•˜ë©´ true, ì•„ë‹ˆë©´ false
    boolean existsByUsername(String username);

    // username ì„ í†µí•´ UserEntity ì°¾ê¸° 
    UserEntity findByUsername(String username);
}

```

1) UserDetailsService ëŠ” DBë¡œ ë¶€í„° íŠ¹ì •í•œ usernameì— ëŒ€í•œ ë°ì´í„°ë¥¼ ë“¤ê³ ì˜¬ê±°ê³  

2) ë“¤ê³ ì˜¨ ë°ì´í„°ë¥¼ UserDetails í´ë˜ìŠ¤ì— ë„£ì–´ì„œ SecurityConfigì— ì „ë‹¬í•´ì£¼ë©´ SecurityConfigê°€ usernameì— ëŒ€í•œ password, íŠ¹ì •í•œ roleë“¤ì„ ê²€ì¦í•¨

3) ê²€ì¦ì´ ì™„ë£Œë˜ë©´ ìŠ¤í”„ë§ ì„¸ì…˜ì— ì €ì¥í•´ì„œ ì‚¬ìš©ìê°€ ë“¤ì–´ì˜¤ë©´ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•´ì¤Œ 

1. CustomUserDetails Dto ìƒì„±

```java
package com.example.securityprac.dto;

import com.example.securityprac.entity.UserEntity;
import lombok.Getter;
import lombok.RequiredArgsConstructor;
import lombok.Setter;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;

import java.util.ArrayList;
import java.util.Collection;

@Getter
@Setter
public class CustomUserDetails implements UserDetails {

    private UserEntity userEntity;

    public CustomUserDetails(UserEntity userEntity) {
        this.userEntity = userEntity;
    }

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() { // ì‚¬ìš©ìì˜ íŠ¹ì • ê¶Œí•œì„ return
        // DBì— ì €ì¥í•  ë•Œ ì§€ì •í–ˆë˜ role ê°’

        Collection<GrantedAuthority> collection = new ArrayList<>();

        collection.add(new GrantedAuthority() {
            @Override
            public String getAuthority() {
                return userEntity.getRole();
            }
        });

        return collection;
    }

    @Override
    public String getPassword() {
        return userEntity.getPassword();
    }

    @Override
    public String getUsername() {
        return userEntity.getUsername();
    }

    // ì¼ë‹¨ ê°œë°œ ê³¼ì •ì—ì„œëŠ” ë§Œë£Œë˜ì§€ ì•Šì•˜ë‹¤ê³  ì§€ì • (ê·¸ë˜ì•¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ) 
    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override
    public boolean isEnabled() {
        return true;
    }
}

```
